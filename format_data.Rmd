---
title: "Athletics Scraping"
author: "Emma Strawbridge"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyr)
library(robotstxt)
library(stringr)
library(dplyr)
library(latex2exp)
library(RColorBrewer)
```

to do:
add readme
add tables at the end

```{r collect files}
# When this project was done, I did 22 (2022-2023) school year and 23 (2023-2024) school year. 
files_22 <- list.files(pattern = "22.txt", recursive = TRUE)
files_23 <- list.files(pattern = "23.txt", recursive = TRUE)
# This travel mileage document was just created in excel and saved as a csv
# For a different school it's going to be totally different
travel_distance <- read.csv("data/travel_mileage.csv", header = TRUE)

# dfmice = read.delim('/Users/estrawbridge/Desktop/amherst/SDS Fellows/SustainabilitySDSFellowProject/Athletics Emissions/data/mice23.txt', sep='\t', header = TRUE) 
# mice_num <- formatify(dfmice)
```


```{r}
data_framer <- function(file) {
  df <- read.delim(file, sep="\t", header = TRUE)
  # this first section formats the data so I can start changing the variables into what I need them to be
  tn <- word(df[1], start=2, end=3, sep=fixed(" "))
  team_name <- "dummy"
  team_name = case_when( 
      tn[1] == "Men's Ice" ~ "mice",
      tn[1] == "Women's Ice" ~ "wice", 
      tn[1] == "Baseball Schedule\"," ~ "baseball", 
      tn[1] == "Women's Basketball" ~ "wbball", 
      tn[1] == "Men's Basketball" ~ "mbball", 
      tn[1] == "Women's Cross" | tn == "Men's Cross" ~ "xc", # same schedule M/W at Amherst
      tn[1] == "Football Schedule\"," ~ "football", 
      tn[1] == "Women's Golf" ~ "wgolf", 
      tn[1] == "Men's Golf" ~ "mgolf", 
      tn[1] == "Women's Lacrosse" ~ "wlax", 
      tn[1] == "Men's Lacrosse" ~ "mlax", 
      tn[1] == "Women's Soccer" ~ "wsoc", 
      tn[1] == "Men's Soccer" ~ "msoc", 
      tn[1] == "Women's Squash" ~ "wsq", # same schedule M/W at Amherst, separate later
      tn[1] == "Men's Squash" ~ "msq", 
      tn[1] == "Women's Swimming" | tn == "Men's Swimming" ~ "sdt", # same schedule M/W at Amherst
      tn[1] == "Men's Tennis" ~ "mtennis", 
      tn[1] == "Women's Tennis" ~ "wtennis", 
      tn[1] == "Women's Track" | tn == "Men's Track" ~ "tf", # same schedule M/W at Amherst
      tn[1] == "Field Hockey" ~ "fhockey", 
      tn[1] == "Softball Schedule\"," ~ "softball",
      tn[1] == "Volleyball Schedule\"," ~ "vball",
      .default = "problem")
  # Some teams have different first rows going on, this removes the junk text
  if(team_name[1] == "xc") { 
     df <- df[-c(1:2), ]
  } else if(team_name[1] == "wgolf") {
     df <- df[-c(1:2), ]
  } else if(team_name[1] == "mgolf") {
     df <- df[-c(1:2), ]
  } else if(team_name[1] == "tf") {
     df <- df[-c(1:2), ]
  } else {
     df <- df[-c(1:8), ]
  }
  dfr <- data.frame(df) 
  
  # Second organization -- columns
  dfr <- dfr %>%
  rename(placeh = c(1)) %>% 
  # removes text that's getting in the way of reading information we need
  mutate(placeh = str_replace_all(placeh, ":", ""),
         placeh = str_replace_all(placeh, "(EST)", ""),
         placeh = str_replace_all(placeh, "(ET)", ""),
         placeh = str_replace_all(placeh, "/", ""),
         placeh = str_replace_all(placeh, "TBD", "TB D"),
         placeh = str_replace_all(placeh, "TBA", "TB A"),
         placeh = str_replace_all(placeh, " PM or ", "")) %>% 
  separate(placeh, c("A","B","C","D","E","F","G","H","I","J","K")) %>%
  select("A", "B", "F", "G", "H") %>%
  rename("month" = "A", 
         "day" = "B",   
         "h_a" = "F",
         "loc" = "G",
         "loc_2" = "H") %>% # 2nd parse for our repeats of "new" and "trinity" etc.
  mutate(game_n = as.numeric(rownames(dfr)),
         indicator = team_name[1]) %>%
  select(game_n, indicator, loc, loc_2, h_a) %>%
  left_join(travel_distance, join_by(loc, loc_2)) %>%
  mutate(
    # number of vehicles per sport -- this is an Amherst standard and will be different by institution
    n_veh = ifelse(h_a =="Away", 
         case_when(
         team_name == "tf" | team_name == "football" ~ 2,
         .default = 1),1), 
    # transportation type is also Amherst specific -- we are a bus school for the most part
    transp_type = ifelse(h_a =="Away",
                  case_when(
                  team_name == "wgolf" | team_name == "wtennis" | 
                  team_name == "mgolf" | team_name == "mtennis" ~ "van",
                  .default = "pete" # Peter Pan bus 
                  ), "none"),
    # the emissions for real! using EPA DATA, NOT SIMAP as of 10/6/24
    co_2gas = ifelse (h_a == "Away", case_when( # this is in kg also that's why I have *1000
                     transp_type == "van" ~ miles*523*n_veh*2/1000,
                     .default = miles*404*n_veh*2/1000 # Peter Pan bus
                     ), 0) 
         #driving 1 mile on average emits 404g of CO2 w/diesel (peter pan, sustainability office) 
         #driving 1 mile on average emits 523 of CO2 w/gas (van, epa and google) 
        
    ) %>%
    mutate(
    # trip population (in a separate mutate for my sake)
    pop_trip = case_when( #includes coaches except for football (formatted as athletes+coaches)
      team_name[1] == "mice" ~ 28+3,
      team_name[1] == "wice" ~ 22+3, 
      team_name[1] == "baseball" ~ 32+3, 
      team_name[1] == "wbball" ~ 13+1, 
      team_name[1] == "mbball"~ 15+3, 
      team_name[1] == "xc" ~ 23+21+2, 
      team_name[1] == "football" ~ 100, # +8 coaches who all drive, not included here
      team_name[1] == "wgolf" ~ 9+1,
      team_name[1] == "mgolf" ~ 11+1,
      team_name[1] == "wlax" ~ 33+3, 
      team_name[1] == "mlax" ~ 46+3, 
      team_name[1] == "wsoc" ~ 27+3, 
      team_name[1] == "msoc" ~ 35+4, 
      team_name[1] == "wsq" ~ 14+2,
      team_name[1] == "msq" ~ 16+2, 
      team_name[1] == "sdt" ~ 27+23+4, 
      team_name[1] == "mtennis" ~ 12+2, 
      team_name[1] == "wtennis" ~ 12+2, 
      team_name[1] == "tf" ~ 44+56+6, 
      team_name[1] == "fhockey" ~ 22+3, 
      team_name[1] == "softball" ~ 15+2,
      team_name[1] == "vball" ~ 21+2,
      .default = 0)
   ) %>% 
  mutate(co_2pcap = co_2gas/pop_trip)
  return(dfr)
}
```


```{r get all data together}
# for each year section
prep_22 <- sapply(files_22, data_framer)
prep_23 <- sapply(files_23, data_framer)

# first we set up the data frame
# getting the names for the columns
colnames <- rownames(prep_22)

# prepping the empty frame, and making it a global variable
emissions_22 <- data.frame(matrix(ncol = nrow(prep_22), nrow = 0))
colnames(emissions_22) <- colnames

emissions_23 <- data.frame(matrix(ncol = nrow(prep_23), nrow = 0))
colnames(emissions_23) <- colnames

# get each
create_emissions_22 <- function(col){
  hold_data <- as.data.frame(col)
  emissions_22 <- rbind(emissions_22,hold_data)
}

create_emissions_23 <- function(col){
  hold_data <- as.data.frame(col)
  emissions_22 <- rbind(emissions_23,hold_data)
}

# THIS here is what will run and collect all the data, run ONCE
# ERRORS DOWN HERE THO IT"S EMPTY :(
emissions_22 <- apply(X = prep_22, MARGIN = 2, FUN = create_emissions_22)

emissions_23 <- apply(X = prep_23, MARGIN = 2, FUN = create_emissions_23)
```
